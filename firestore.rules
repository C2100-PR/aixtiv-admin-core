service cloud.firestore {
match /databases/{database}/documents {
    // Helper functions for role checking
    function isSignedIn() {
    return request.auth != null;
    }
    
    function isAdmin() {
    return isSignedIn() && 
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isOwner(userId) {
    return isSignedIn() && request.auth.uid == userId;
    }
    
    function hasRole(role) {
    return isSignedIn() && 
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }

    // User collection rules
    match /users/{userId} {
    allow read: if isSignedIn();
    allow create: if isSignedIn() 
                && request.resource.data.role in ['user', 'instructor']
                && request.resource.data.email == request.auth.token.email;
    allow update: if isOwner(userId) || isAdmin();
    allow delete: if isAdmin();

    // User's private data subcollection
    match /private/{document=**} {
        allow read, write: if isOwner(userId) || isAdmin();
    }
    }

    // Courses collection rules
    match /courses/{courseId} {
    // Course data validation
    function isValidCourse() {
        let data = request.resource.data;
        return data.title is string && data.title.size() > 0
            && data.description is string
            && data.instructorId is string
            && data.status in ['draft', 'published', 'archived'];
    }

    allow read: if resource.data.status == 'published' || 
                    isAdmin() || 
                    resource.data.instructorId == request.auth.uid;
    allow create: if (hasRole('instructor') || isAdmin()) && isValidCourse();
    allow update: if (resource.data.instructorId == request.auth.uid || isAdmin()) 
                && isValidCourse();
    allow delete: if isAdmin();

    // Course materials subcollection
    match /materials/{materialId} {
        allow read: if get(/databases/$(database)/documents/courses/$(courseId)).data.status == 'published'
                || isAdmin()
                || get(/databases/$(database)/documents/courses/$(courseId)).data.instructorId == request.auth.uid;
        allow write: if get(/databases/$(database)/documents/courses/$(courseId)).data.instructorId == request.auth.uid
                    || isAdmin();
    }
    }

    // Conferences collection rules
    match /conferences/{conferenceId} {
    function isValidConference() {
        let data = request.resource.data;
        return data.name is string && data.name.size() > 0
            && data.startDate is timestamp
            && data.endDate is timestamp
            && data.startDate < data.endDate;
    }

    allow read: if true;
    allow create, update: if (hasRole('organizer') || isAdmin()) && isValidConference();
    allow delete: if isAdmin();

    // Conference attendees subcollection
    match /attendees/{attendeeId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn() && request.auth.uid == attendeeId;
        allow delete: if isAdmin() || request.auth.uid == attendeeId;
    }
    }

    // Admin-only collections
    match /system/{document=**} {
    allow read, write: if isAdmin();
    }
    
    // Deny all other access by default
    match /{document=**} {
    allow read, write: if false;
    }
}
}
